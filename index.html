<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaCare Pro v5.1 (Fixed & Verified)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #991b1b; border-radius: 4px; }
        .sidebar-gradient { background: linear-gradient(180deg, #450a0a 0%, #000000 100%); }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        
        /* Receipt Print Styling */
        @media print {
            body * { visibility: hidden; }
            #receiptArea, #receiptArea * { visibility: visible; }
            #receiptArea { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <header class="md:hidden bg-[#450a0a] text-white p-4 flex justify-between items-center z-30 shadow-md">
        <div class="flex items-center gap-2">
            <i class="fas fa-prescription-bottle-alt text-lg"></i>
            <span class="font-bold">PharmaCare</span>
        </div>
        <button onclick="toggleSidebar()" class="text-white focus:outline-none"><i class="fas fa-bars text-2xl"></i></button>
    </header>

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 sidebar-gradient text-white transform -translate-x-full md:relative md:translate-x-0 z-40 sidebar-transition flex flex-col shadow-2xl border-r border-red-900 h-full">
        <div class="p-6 flex items-center gap-3 bg-black/20">
            <div class="bg-red-600 p-2 rounded-lg shadow-lg">
                <i class="fas fa-prescription-bottle-alt text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg">PharmaCare</h1>
                <p class="text-xs text-red-200">System v5.1</p>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden ml-auto text-gray-400"><i class="fas fa-times"></i></button>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-6 overflow-y-auto">
            <p class="px-4 text-xs font-bold text-red-400 uppercase tracking-wider mb-2">Main</p>
            <button onclick="showSection('sales-terminal')" class="nav-btn w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition hover:bg-red-800 active-nav">
                <i class="fas fa-cash-register w-5 text-red-300"></i> Sales Terminal
            </button>
            <button onclick="showSection('inventory')" class="nav-btn w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition hover:bg-red-800">
                <i class="fas fa-boxes w-5 text-red-300"></i> Inventory
            </button>
            
            <p class="px-4 text-xs font-bold text-red-400 uppercase tracking-wider mb-2 mt-6">Business</p>
            <button onclick="showSection('sales-history')" class="nav-btn w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition hover:bg-red-800">
                <i class="fas fa-history w-5 text-red-300"></i> History & Bills
            </button>
            <button onclick="showSection('reports')" class="nav-btn w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition hover:bg-red-800">
                <i class="fas fa-chart-line w-5 text-red-300"></i> Profit Report
            </button>
            <button onclick="showSection('purchases')" class="nav-btn w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition hover:bg-red-800">
                <i class="fas fa-truck-loading w-5 text-red-300"></i> Buying Records
            </button>

            <p class="px-4 text-xs font-bold text-red-400 uppercase tracking-wider mb-2 mt-6">Data</p>
            <button onclick="downloadBackup()" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-xl text-xs text-gray-300 hover:bg-red-900">
                <i class="fas fa-download"></i> Save to PC
            </button>
            <button onclick="document.getElementById('restoreInput').click()" class="w-full text-left flex items-center gap-3 px-4 py-2 rounded-xl text-xs text-gray-300 hover:bg-red-900">
                <i class="fas fa-upload"></i> Restore on Mobile
            </button>
            <input type="file" id="restoreInput" class="hidden" accept=".json" onchange="restoreBackup(this)">
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 w-full">
        
        <section id="sales-terminal" class="content-section flex flex-col h-full">
            <header class="h-16 md:h-20 bg-white border-b flex items-center justify-between px-4 md:px-8 shadow-sm">
                <h2 class="text-lg md:text-2xl font-bold text-slate-800"><i class="fas fa-cash-register text-red-700 mr-2"></i> Sales</h2>
                <div class="bg-red-50 text-red-700 px-3 py-1 rounded-lg font-bold border border-red-100 text-xs md:text-base">
                    Today: <span id="todaySalesTotal">Rs. 0</span>
                </div>
            </header>
            <div class="p-4 md:p-8 flex-1 overflow-auto">
                <div class="max-w-3xl mx-auto">
                    <div class="relative mb-6">
                        <input type="text" id="salesSearch" placeholder="Search Medicine..." class="w-full pl-10 md:pl-12 pr-4 py-3 md:py-4 rounded-2xl border-2 border-red-100 focus:border-red-500 outline-none shadow-lg text-lg">
                        <i class="fas fa-search absolute left-4 top-4 md:top-5 text-red-400 text-xl"></i>
                    </div>
                    <div id="salesResults" class="grid gap-3"></div>
                </div>
            </div>
        </section>

        <section id="inventory" class="content-section hidden flex flex-col h-full">
            <header class="h-auto md:h-20 py-4 bg-white border-b flex flex-col md:flex-row items-center justify-between px-4 md:px-8 gap-3">
                <h2 class="text-xl md:text-2xl font-bold text-slate-800">Inventory</h2>
                <button onclick="openModal()" class="w-full md:w-auto bg-red-700 text-white px-6 py-2 rounded-xl font-bold shadow-lg transition hover:bg-red-800">
                    <i class="fas fa-plus mr-2"></i> Add Medicine
                </button>
            </header>
            <div class="p-4 md:p-8 overflow-auto pb-24">
                <div id="inventoryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
        </section>

        <section id="sales-history" class="content-section hidden flex flex-col h-full">
            <header class="h-16 md:h-20 bg-white border-b flex items-center justify-between px-4 md:px-8">
                <h2 class="text-lg md:text-2xl font-bold text-slate-800">Sales History</h2>
                <button onclick="clearHistory('sales')" class="text-red-500 text-sm">Clear</button>
            </header>
            <div class="p-4 md:p-8 overflow-auto">
                <div class="overflow-x-auto rounded-xl border border-gray-100">
                    <table class="w-full text-left bg-white shadow-sm min-w-[600px]">
                        <thead class="bg-red-50 text-red-700 text-xs uppercase">
                            <tr>
                                <th class="p-4">Date</th>
                                <th class="p-4">Medicine</th>
                                <th class="p-4">Qty</th>
                                <th class="p-4">Amount</th>
                                <th class="p-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistoryTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="reports" class="content-section hidden flex flex-col h-full">
            <header class="h-16 md:h-20 bg-white border-b flex items-center px-4 md:px-8">
                <h2 class="text-lg md:text-2xl font-bold text-slate-800">Profit Reports</h2>
            </header>
            <div class="p-8 overflow-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                        <p class="text-blue-600 text-sm font-bold uppercase">Total Revenue</p>
                        <p class="text-3xl font-bold text-blue-900" id="reportRevenue">Rs. 0</p>
                    </div>
                    <div class="bg-red-50 p-6 rounded-2xl border border-red-100">
                        <p class="text-red-600 text-sm font-bold uppercase">Estimated Cost</p>
                        <p class="text-3xl font-bold text-red-900" id="reportCost">Rs. 0</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-2xl border border-green-100 shadow-sm">
                        <p class="text-green-600 text-sm font-bold uppercase">Net Profit</p>
                        <p class="text-3xl font-bold text-green-900" id="reportProfit">Rs. 0</p>
                    </div>
                </div>
                <p class="text-gray-400 text-xs">* Profit is calculated as (Selling Price - Buying Price) * Units Sold.</p>
            </div>
        </section>

        <section id="purchases" class="content-section hidden flex flex-col h-full">
             <header class="h-16 md:h-20 bg-white border-b flex items-center justify-between px-4 md:px-8">
                <h2 class="text-lg md:text-2xl font-bold text-slate-800">Purchases</h2>
                <button onclick="document.getElementById('purchaseModal').classList.remove('hidden')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm shadow-lg">Add Record</button>
            </header>
            <div class="p-4 overflow-auto grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3" id="purchaseGrid"></div>
        </section>
    </main>

    <div id="medicineModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-red-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg">Medicine Details</h3>
                <button onclick="closeModal('medicineModal')"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="medicineForm" onsubmit="saveMedicine(event)" class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="medicineId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div><label class="label">Name</label><input type="text" id="name" required class="input"></div>
                    <div><label class="label">Brand</label><input type="text" id="brand" class="input"></div>
                    <div><label class="label">Formula</label><input type="text" id="formula" class="input"></div>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <p class="text-xs font-bold text-yellow-700 mb-2 uppercase">Pricing (Per Pack)</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="label">Buying Price (Cost)</label><input type="number" id="buyPrice" required class="input bg-white"></div>
                        <div><label class="label">Selling Price</label><input type="number" id="sellPrice" required class="input bg-white" oninput="updateUnitDisplay()"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div><label class="label">Items per Pack</label><input type="number" id="packSize" value="1" required class="input" oninput="updateUnitDisplay()"></div>
                    <div><label class="label">Total Stock (Units)</label><input type="number" id="stock" required class="input"></div>
                </div>
                <p class="text-right text-xs font-bold text-green-600" id="unitPriceDisplay">Profit per unit: Rs 0</p>

                <div class="grid grid-cols-2 gap-3">
                    <div><label class="label">Category</label><select id="category" class="input"><option>Tablet</option><option>Capsule</option><option>Syrup</option><option>Injection</option></select></div>
                    <div><label class="label">Expiry</label><input type="date" id="expiry" required class="input"></div>
                </div>
                <div><label class="label">Image</label><input type="file" id="imageInput" accept="image/*" class="w-full text-sm"></div>
                <button type="submit" class="w-full bg-red-800 text-white py-3 rounded-xl font-bold">Save Medicine</button>
            </form>
        </div>
    </div>

    <div id="purchaseModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-emerald-700 px-6 py-4 text-white font-bold flex justify-between"><h3>Record Purchase</h3><button onclick="closeModal('purchaseModal')"><i class="fas fa-times"></i></button></div>
            <form onsubmit="savePurchase(event)" class="p-6 space-y-4">
                <input type="text" id="dealerName" required placeholder="Dealer Name" class="input">
                <input type="text" id="companyName" required placeholder="Company Name" class="input">
                <textarea id="itemsBought" required placeholder="Items..." class="input h-24"></textarea>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="purchaseAmount" required placeholder="Amount" class="input">
                    <input type="date" id="purchaseDate" required class="input">
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Save Record</button>
            </form>
        </div>
    </div>

    <div id="saleModal" class="fixed inset-0 bg-black/70 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden text-center">
            <div class="bg-green-600 p-4"><h3 class="text-white font-bold text-xl">Sell Item</h3></div>
            <div class="p-6">
                <h4 id="saleItemName" class="font-bold text-lg">Name</h4>
                <div class="flex justify-center items-center gap-2 my-4">
                    <input type="number" id="saleQty" class="input text-center text-xl w-24" value="1" min="1" oninput="calcSale()">
                    <span class="font-bold">Units</span>
                </div>
                <p class="text-3xl font-bold text-green-700 mb-4" id="saleTotal">Rs. 0</p>
                <div class="flex gap-2">
                    <button onclick="closeModal('saleModal')" class="flex-1 bg-gray-200 py-2 rounded-lg font-bold">Cancel</button>
                    <button onclick="confirmSale()" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div id="receiptArea" class="hidden bg-white p-4 text-center">
        <h2 class="text-xl font-bold">PHARMACARE</h2>
        <p class="text-sm text-gray-500 mb-4">Official Receipt</p>
        <div class="border-t border-b border-gray-300 py-2 my-2 text-left">
            <p><strong>Item:</strong> <span id="billItem"></span></p>
            <p><strong>Qty:</strong> <span id="billQty"></span></p>
            <p><strong>Date:</strong> <span id="billDate"></span></p>
        </div>
        <h3 class="text-2xl font-bold mt-2">Total: Rs. <span id="billTotal"></span></h3>
        <p class="text-xs mt-4">Thank you for your purchase!</p>
    </div>

    <style> .label { font-size: 0.7rem; font-weight: 700; color: #555; display: block; margin-bottom: 2px; } .input { width: 100%; border: 1px solid #ddd; padding: 8px; rounded: 8px; outline: none; } </style>

    <script>
        // --- 1. DATA INITIALIZATION ---
        const sampleData = [
            { id: 1, name: 'Panadol', brand: 'GSK', formula: 'Paracetamol', buyPrice: 100, price: 150, packSize: 100, stock: 500, category: 'Tablet', expiry: '2026-12-01', image: null },
            { id: 2, name: 'Brufen', brand: 'Abbott', formula: 'Ibuprofen', buyPrice: 80, price: 120, packSize: 1, stock: 15, category: 'Syrup', expiry: '2025-06-15', image: null },
            { id: 3, name: 'Augmentin', brand: 'GSK', formula: 'Amox+Clav', buyPrice: 350, price: 440, packSize: 6, stock: 30, category: 'Tablet', expiry: '2025-08-01', image: null }
        ];

        let inventory = JSON.parse(localStorage.getItem('pharmacyInv_v5')) || [];
        if(inventory.length === 0) inventory = sampleData;

        let salesHistory = JSON.parse(localStorage.getItem('pharmacySales_v5')) || [];
        let purchaseHistory = JSON.parse(localStorage.getItem('pharmacyPurchases_v5')) || [];

        // --- 2. NAVIGATION ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ol = document.getElementById('mobileOverlay');
            sb.classList.toggle('-translate-x-full');
            ol.classList.toggle('hidden');
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(window.innerWidth < 768) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobileOverlay').classList.add('hidden'); }
            
            if(id === 'inventory') renderInventory();
            if(id === 'sales-history') renderHistory();
            if(id === 'reports') renderReports();
            if(id === 'purchases') renderPurchases();
        }

        // --- 3. SALES LOGIC ---
        document.getElementById('salesSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const res = document.getElementById('salesResults');
            res.innerHTML = '';
            if(term.length < 1) return;

            inventory.filter(i => i.name.toLowerCase().includes(term)).forEach(item => {
                const unitPrice = (item.price / item.packSize).toFixed(2);
                const stockColor = item.stock < 10 ? 'bg-red-50 border-red-300' : 'bg-white border-red-50';
                const stockText = item.stock < 10 ? `<span class="text-red-600 font-bold animate-pulse">LOW STOCK: ${item.stock}</span>` : `Stock: ${item.stock}`;

                res.innerHTML += `
                <div onclick="openSaleModal(${item.id})" class="${stockColor} p-4 rounded-xl shadow border flex justify-between items-center cursor-pointer hover:bg-red-100 transition">
                    <div>
                        <h4 class="font-bold text-lg">${item.name}</h4>
                        <p class="text-xs text-gray-500">${item.brand}</p>
                        <p class="text-xs mt-1">${stockText}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">Unit Price</p>
                        <p class="text-xl font-bold text-green-600">Rs. ${unitPrice}</p>
                    </div>
                </div>`;
            });
        });

        let currentSale = null;
        function openSaleModal(id) {
            currentSale = inventory.find(i => i.id === id);
            document.getElementById('saleItemName').innerText = currentSale.name;
            document.getElementById('saleQty').value = 1;
            document.getElementById('saleModal').classList.remove('hidden');
            calcSale();
        }

        function calcSale() {
            const qty = document.getElementById('saleQty').value;
            const unitPrice = currentSale.price / currentSale.packSize;
            document.getElementById('saleTotal').innerText = `Rs. ${Math.ceil(unitPrice * qty)}`;
        }

        function confirmSale() {
            const qty = parseInt(document.getElementById('saleQty').value);
            if(qty > currentSale.stock) return alert('Not enough stock!');
            
            const unitSell = currentSale.price / currentSale.packSize;
            const unitBuy = (currentSale.buyPrice || 0) / currentSale.packSize;
            const totalSell = Math.ceil(unitSell * qty);
            const totalBuy = Math.ceil(unitBuy * qty);
            const profit = totalSell - totalBuy;

            currentSale.stock -= qty;
            salesHistory.unshift({
                id: Date.now(),
                name: currentSale.name,
                qty: qty,
                total: totalSell,
                cost: totalBuy,
                profit: profit,
                date: new Date().toLocaleString()
            });

            saveAll();
            closeModal('saleModal');
            document.getElementById('salesSearch').value = '';
            document.getElementById('salesResults').innerHTML = '';
            updateDaily();
            showSection('sales-history');
        }

        // --- 4. INVENTORY LOGIC (FIXED DELETE/EDIT) ---
        function resizeImage(file, callback) {
            if(!file) return callback(null);
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = 300 / img.width;
                    canvas.width = 300;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function saveMedicine(e) {
            e.preventDefault();
            const file = document.getElementById('imageInput').files[0];
            resizeImage(file, (base64Img) => {
                const id = document.getElementById('medicineId').value;
                const buyP = parseFloat(document.getElementById('buyPrice').value);
                const sellP = parseFloat(document.getElementById('sellPrice').value);
                const size = parseInt(document.getElementById('packSize').value);

                const item = {
                    id: id ? parseInt(id) : Date.now(),
                    name: document.getElementById('name').value,
                    brand: document.getElementById('brand').value,
                    formula: document.getElementById('formula').value,
                    buyPrice: buyP,
                    price: sellP,
                    packSize: size,
                    stock: parseInt(document.getElementById('stock').value),
                    category: document.getElementById('category').value,
                    expiry: document.getElementById('expiry').value,
                    image: base64Img || null
                };

                if(id) {
                    const idx = inventory.findIndex(i => i.id == id);
                    if(!item.image) item.image = inventory[idx].image; 
                    inventory[idx] = item;
                } else {
                    inventory.push(item);
                }
                saveAll();
                closeModal('medicineModal');
                renderInventory();
            });
        }

        function deleteMedicine(id) {
            if(confirm('Are you sure you want to delete this medicine?')) {
                inventory = inventory.filter(i => i.id !== id);
                saveAll();
                renderInventory();
            }
        }

        function editMedicine(id) {
            const item = inventory.find(i => i.id === id);
            document.getElementById('medicineId').value = item.id;
            document.getElementById('name').value = item.name;
            document.getElementById('brand').value = item.brand;
            document.getElementById('formula').value = item.formula;
            document.getElementById('buyPrice').value = item.buyPrice || 0;
            document.getElementById('sellPrice').value = item.price;
            document.getElementById('packSize').value = item.packSize;
            document.getElementById('stock').value = item.stock;
            document.getElementById('category').value = item.category;
            document.getElementById('expiry').value = item.expiry;
            document.getElementById('medicineModal').classList.remove('hidden');
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            inventory.forEach(item => {
                const img = item.image || `https://ui-avatars.com/api/?name=${item.name}&background=fee2e2&color=991b1b`;
                const profit = ((item.price - (item.buyPrice || 0))/item.packSize).toFixed(1);
                
                // Fixed: Edit/Delete buttons are visible now
                grid.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative group">
                    <div class="absolute top-2 right-2 flex gap-1">
                        <button onclick="editMedicine(${item.id})" class="text-blue-500 bg-blue-50 p-2 rounded-full text-xs hover:bg-blue-100"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteMedicine(${item.id})" class="text-red-500 bg-red-50 p-2 rounded-full text-xs hover:bg-red-100"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="flex items-center gap-3 mb-3">
                        <img src="${img}" class="w-12 h-12 rounded-lg object-cover bg-red-50">
                        <div>
                            <h4 class="font-bold">${item.name}</h4>
                            <p class="text-xs text-red-500 font-bold">${item.stock} Units</p>
                        </div>
                    </div>
                    <div class="text-xs bg-gray-50 p-2 rounded grid grid-cols-2 gap-1">
                        <span>Buy: ${item.buyPrice}</span>
                        <span>Sell: ${item.price}</span>
                        <span class="col-span-2 text-green-600 font-bold">Est. Profit/Unit: Rs. ${profit}</span>
                    </div>
                </div>`;
            });
        }

        // --- 5. PURCHASES & HISTORY LOGIC (RESTORED) ---
        function savePurchase(e) {
            e.preventDefault();
            const record = {
                id: Date.now(),
                dealer: document.getElementById('dealerName').value,
                company: document.getElementById('companyName').value,
                items: document.getElementById('itemsBought').value,
                amount: document.getElementById('purchaseAmount').value,
                date: document.getElementById('purchaseDate').value
            };
            purchaseHistory.unshift(record);
            saveAll();
            closeModal('purchaseModal');
            renderPurchases();
        }

        function renderPurchases() {
            const grid = document.getElementById('purchaseGrid');
            grid.innerHTML = '';
            purchaseHistory.forEach(p => {
                grid.innerHTML += `
                <div class="bg-white p-4 rounded-xl shadow border">
                    <h4 class="font-bold text-emerald-800">${p.dealer}</h4>
                    <p class="text-xs font-bold uppercase mb-2">${p.company}</p>
                    <p class="text-sm text-gray-600 mb-2">${p.items}</p>
                    <div class="flex justify-between items-center text-xs">
                        <span class="bg-gray-100 p-1 rounded">${p.date}</span>
                        <span class="font-bold text-green-600 text-lg">Rs. ${p.amount}</span>
                    </div>
                </div>`;
            });
        }

        function clearHistory(type) {
            if(confirm('Clear all sales history?')) {
                salesHistory = [];
                saveAll();
                renderHistory();
                renderReports();
            }
        }

        function renderHistory() {
            const tbody = document.getElementById('salesHistoryTable');
            tbody.innerHTML = '';
            salesHistory.forEach(s => {
                tbody.innerHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 text-xs">${s.date.split(',')[0]}</td>
                    <td class="p-3 font-bold text-sm">${s.name}</td>
                    <td class="p-3 text-xs">${s.qty}</td>
                    <td class="p-3 font-bold text-green-600">Rs.${s.total}</td>
                    <td class="p-3">
                        <button onclick="printBill(${s.id})" class="bg-gray-800 text-white px-3 py-1 rounded text-xs"><i class="fas fa-print"></i></button>
                    </td>
                </tr>`;
            });
        }

        function printBill(id) {
            const s = salesHistory.find(x => x.id === id);
            document.getElementById('billItem').innerText = s.name;
            document.getElementById('billQty').innerText = s.qty;
            document.getElementById('billDate').innerText = s.date;
            document.getElementById('billTotal').innerText = s.total;
            window.print();
        }

        function renderReports() {
            const totalRev = salesHistory.reduce((a, b) => a + b.total, 0);
            const totalCost = salesHistory.reduce((a, b) => a + (b.cost || 0), 0);
            const totalProfit = salesHistory.reduce((a, b) => a + (b.profit || 0), 0);
            document.getElementById('reportRevenue').innerText = `Rs. ${totalRev}`;
            document.getElementById('reportCost').innerText = `Rs. ${totalCost}`;
            document.getElementById('reportProfit').innerText = `Rs. ${totalProfit}`;
        }

        // --- HELPERS ---
        function updateUnitDisplay() {
            const buy = document.getElementById('buyPrice').value;
            const sell = document.getElementById('sellPrice').value;
            const size = document.getElementById('packSize').value;
            const profit = ((sell - buy) / size).toFixed(2);
            document.getElementById('unitPriceDisplay').innerText = `Est. Profit per Unit: Rs. ${profit}`;
        }
        function saveAll() {
            localStorage.setItem('pharmacyInv_v5', JSON.stringify(inventory));
            localStorage.setItem('pharmacySales_v5', JSON.stringify(salesHistory));
            localStorage.setItem('pharmacyPurchases_v5', JSON.stringify(purchaseHistory));
        }
        function updateDaily() {
            const today = new Date().toLocaleDateString();
            const total = salesHistory.filter(s => new Date(s.date).toLocaleDateString() === today).reduce((a,b)=>a+b.total,0);
            document.getElementById('todaySalesTotal').innerText = `Rs. ${total}`;
        }
        function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
        function openModal(){ document.getElementById('medicineForm').reset(); document.getElementById('medicineId').value=''; document.getElementById('medicineModal').classList.remove('hidden'); }
        
        function downloadBackup() {
            const d = { inv: localStorage.getItem('pharmacyInv_v5'), sales: localStorage.getItem('pharmacySales_v5'), purch: localStorage.getItem('pharmacyPurchases_v5') };
            const b = new Blob([JSON.stringify(d)],{type:'application/json'});
            const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click();
        }
        function restoreBackup(input) {
            const f = input.files[0]; if(!f)return;
            const r = new FileReader(); r.onload=(e)=>{
                const d = JSON.parse(e.target.result);
                if(d.inv) localStorage.setItem('pharmacyInv_v5', d.inv);
                if(d.sales) localStorage.setItem('pharmacySales_v5', d.sales);
                if(d.purch) localStorage.setItem('pharmacyPurchases_v5', d.purch);
                location.reload();
            }; r.readAsText(f);
        }

        // Init
        showSection('sales-terminal'); updateDaily();
    </script>
</body>
</html>
